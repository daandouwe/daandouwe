<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - Daan Douwe Bouwen</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F7ECD6;
            color: #063B40;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1, h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        h2 {
            font-size: 20px;
            margin-top: 40px;
            border-bottom: 2px solid #063B40;
            padding-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .hidden {
            display: none !important;
        }
        .login-section {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        .login-section input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        .login-section input:focus {
            border-color: #063B40;
            outline: none;
        }
        .login-btn {
            background: #063B40;
            color: #F7ECD6;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .login-error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .login-error.show {
            display: block;
        }
        .upload-area {
            border: 3px dashed #063B40;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-area:hover, .upload-area.dragover {
            background: rgba(6, 59, 64, 0.1);
        }
        .upload-area input {
            display: none;
        }
        .btn {
            background: #063B40;
            color: #F7ECD6;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #dc3545;
        }
        .preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        .status.uploading {
            background: #fff3cd;
            color: #856404;
            display: block;
        }
        .progress {
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        .progress.show {
            display: block;
        }
        .progress-bar {
            height: 100%;
            background: #063B40;
            width: 0%;
            transition: width 0.3s;
        }
        .config {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .config label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .config input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .config input:focus {
            border-color: #063B40;
            outline: none;
        }
        .save-config {
            font-size: 14px;
            color: #666;
        }
        a {
            color: #063B40;
        }

        /* Existing images grid */
        .existing-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .image-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .image-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }
        .image-card .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0.9;
        }
        .image-card .delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .image-card.deleting {
            opacity: 0.5;
            pointer-events: none;
        }
        .image-card .image-name {
            padding: 8px;
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .image-count {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .image-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        .image-card.drag-over {
            border: 2px dashed #063B40;
        }
        .image-card {
            cursor: grab;
            transition: transform 0.2s, opacity 0.2s;
        }
        .image-card:active {
            cursor: grabbing;
        }
        .order-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .order-buttons .btn {
            flex: 1;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .order-changed {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="login-error" id="loginError">Onjuist wachtwoord</div>
            <input type="password" id="passwordInput" placeholder="Wachtwoord" autocomplete="off">
            <button class="login-btn" id="loginBtn">Inloggen</button>
        </div>

        <!-- Upload Section (hidden until logged in) -->
        <div id="uploadSection" class="hidden">
            <h1>Portfolio Beheer</h1>
            <p class="subtitle">Upload en beheer je portfolio foto's</p>

            <div class="config" id="configSection">
                <label for="cloudName">Cloudinary Cloud Name</label>
                <input type="text" id="cloudName" placeholder="bijv. dxxxxx">

                <label for="uploadPreset">Upload Preset</label>
                <input type="text" id="uploadPreset" placeholder="bijv. portfolio-upload" value="portfolio-upload">

                <label for="folder">Folder</label>
                <input type="text" id="folder" placeholder="bijv. portfolio" value="portfolio">

                <p class="save-config">Deze instellingen worden opgeslagen in je browser.</p>
            </div>

            <h2>Upload nieuwe foto's</h2>

            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept="image/*" multiple>
                <p>Tik om foto's te selecteren<br>of sleep ze hierheen</p>
            </div>

            <div class="preview" id="preview"></div>

            <div class="progress" id="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="status" id="status"></div>

            <button class="btn" id="uploadBtn" disabled>Upload Foto's</button>

            <h2>Bestaande foto's</h2>
            <p style="color: #666; font-size: 14px;">Sleep foto's om de volgorde te wijzigen</p>
            <div class="image-count" id="imageCount"></div>
            <div class="order-changed" id="orderChanged" style="display: none;">
                Volgorde gewijzigd - vergeet niet op te slaan!
            </div>
            <div class="existing-images" id="existingImages">
                <div class="loading">Laden...</div>
            </div>
            <div class="order-buttons" id="orderButtons" style="display: none;">
                <button class="btn" id="saveOrderBtn">Volgorde Opslaan</button>
                <button class="btn btn-secondary" id="resetOrderBtn">Annuleren</button>
            </div>
            <button class="btn btn-danger" id="deleteAllBtn" style="margin-top: 20px; display: none;">Alles Verwijderen</button>

            <p style="margin-top: 30px; text-align: center;">
                <a href="./">Terug naar Home</a> | <a href="./gallery/">Bekijk Gallery</a>
            </p>
        </div>
    </div>

    <script>
        // Elements
        const loginSection = document.getElementById('loginSection');
        const uploadSection = document.getElementById('uploadSection');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        // Check if already authenticated this session
        if (sessionStorage.getItem('upload_authenticated') === 'true') {
            showUploadSection();
        }

        // Login handling
        loginBtn.addEventListener('click', verifyPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyPassword();
        });

        async function verifyPassword() {
            const password = passwordInput.value;
            if (!password) return;

            loginBtn.disabled = true;
            loginBtn.textContent = 'Controleren...';
            loginError.classList.remove('show');

            try {
                const response = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    sessionStorage.setItem('upload_authenticated', 'true');
                    showUploadSection();
                } else {
                    loginError.classList.add('show');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Er ging iets mis. Probeer opnieuw.';
                loginError.classList.add('show');
            }

            loginBtn.disabled = false;
            loginBtn.textContent = 'Inloggen';
        }

        function showUploadSection() {
            loginSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            loadExistingImages();
        }

        // Upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const uploadBtn = document.getElementById('uploadBtn');
        const status = document.getElementById('status');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const cloudNameInput = document.getElementById('cloudName');
        const uploadPresetInput = document.getElementById('uploadPreset');
        const folderInput = document.getElementById('folder');
        const existingImagesContainer = document.getElementById('existingImages');
        const imageCount = document.getElementById('imageCount');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const orderButtons = document.getElementById('orderButtons');
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const resetOrderBtn = document.getElementById('resetOrderBtn');
        const orderChanged = document.getElementById('orderChanged');

        let allImages = [];
        let originalOrder = [];
        let orderHasChanged = false;

        let selectedFiles = [];

        // Load saved config
        cloudNameInput.value = localStorage.getItem('cloudinary_cloud_name') || '';
        uploadPresetInput.value = localStorage.getItem('cloudinary_upload_preset') || 'portfolio-upload';
        folderInput.value = localStorage.getItem('cloudinary_folder') || 'portfolio';

        // Save config on change
        [cloudNameInput, uploadPresetInput, folderInput].forEach(input => {
            input.addEventListener('change', () => {
                localStorage.setItem('cloudinary_cloud_name', cloudNameInput.value);
                localStorage.setItem('cloudinary_upload_preset', uploadPresetInput.value);
                localStorage.setItem('cloudinary_folder', folderInput.value);
            });
        });

        // Click to select files
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // File selection
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            preview.innerHTML = '';

            selectedFiles.forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            });

            uploadBtn.disabled = selectedFiles.length === 0 || !cloudNameInput.value;
            status.className = 'status';
        }

        // Check if upload button should be enabled
        cloudNameInput.addEventListener('input', () => {
            uploadBtn.disabled = selectedFiles.length === 0 || !cloudNameInput.value;
        });

        // Upload
        uploadBtn.addEventListener('click', async () => {
            const cloudName = cloudNameInput.value.trim();
            const uploadPreset = uploadPresetInput.value.trim();
            const folder = folderInput.value.trim();

            if (!cloudName || !uploadPreset) {
                status.textContent = 'Vul eerst je Cloudinary instellingen in.';
                status.className = 'status error';
                return;
            }

            uploadBtn.disabled = true;
            progress.classList.add('show');
            status.textContent = 'Uploading...';
            status.className = 'status uploading';

            let uploaded = 0;
            let failed = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);
                if (folder) {
                    formData.append('folder', folder);
                }

                try {
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
                        { method: 'POST', body: formData }
                    );

                    if (response.ok) {
                        uploaded++;
                    } else {
                        const error = await response.json();
                        console.error('Upload failed:', error);
                        failed++;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    failed++;
                }

                // Update progress
                const percent = Math.round(((i + 1) / selectedFiles.length) * 100);
                progressBar.style.width = percent + '%';
            }

            // Done
            progress.classList.remove('show');
            selectedFiles = [];
            preview.innerHTML = '';
            fileInput.value = '';

            if (failed === 0) {
                status.textContent = `${uploaded} foto('s) succesvol geupload!`;
                status.className = 'status success';
            } else {
                status.textContent = `${uploaded} geupload, ${failed} mislukt. Controleer je instellingen.`;
                status.className = 'status error';
            }

            uploadBtn.disabled = true;

            // Reload existing images
            loadExistingImages();
        });

        // Load existing images from Cloudinary
        async function loadExistingImages() {
            existingImagesContainer.innerHTML = '<div class="loading">Laden...</div>';

            try {
                const response = await fetch('/api/images');
                if (response.ok) {
                    const data = await response.json();
                    renderExistingImages(data.images || []);
                } else {
                    existingImagesContainer.innerHTML = '<div class="loading">Kon afbeeldingen niet laden</div>';
                }
            } catch (error) {
                console.error('Failed to load images:', error);
                existingImagesContainer.innerHTML = '<div class="loading">Fout bij laden</div>';
            }
        }

        function renderExistingImages(images) {
            allImages = images;
            originalOrder = images.map(img => img.id);
            orderHasChanged = false;
            orderChanged.style.display = 'none';
            orderButtons.style.display = 'none';
            imageCount.textContent = `${images.length} foto('s) in portfolio`;

            if (images.length === 0) {
                existingImagesContainer.innerHTML = '<div class="loading">Geen foto\'s gevonden</div>';
                deleteAllBtn.style.display = 'none';
                return;
            }

            deleteAllBtn.style.display = 'block';
            existingImagesContainer.innerHTML = images.map((img, index) => `
                <div class="image-card" data-id="${img.id}" data-index="${index}" draggable="true">
                    <img src="${img.thumbnail}" alt="Portfolio image" draggable="false">
                    <button class="delete-btn" onclick="deleteImage('${img.id}')" title="Verwijderen">&times;</button>
                    <div class="image-name">${img.id.split('/').pop()}</div>
                </div>
            `).join('');

            // Add drag-and-drop event listeners
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.image-card');
            let draggedCard = null;

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                    document.querySelectorAll('.image-card').forEach(c => c.classList.remove('drag-over'));
                });

                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (draggedCard && draggedCard !== card) {
                        card.classList.add('drag-over');
                    }
                });

                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over');
                });

                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.classList.remove('drag-over');

                    if (draggedCard && draggedCard !== card) {
                        const container = existingImagesContainer;
                        const allCards = [...container.querySelectorAll('.image-card')];
                        const draggedIndex = allCards.indexOf(draggedCard);
                        const targetIndex = allCards.indexOf(card);

                        if (draggedIndex < targetIndex) {
                            card.after(draggedCard);
                        } else {
                            card.before(draggedCard);
                        }

                        updateImageOrder();
                    }
                });
            });
        }

        function updateImageOrder() {
            const cards = [...existingImagesContainer.querySelectorAll('.image-card')];
            const newOrder = cards.map(card => card.dataset.id);

            // Check if order changed
            orderHasChanged = !originalOrder.every((id, i) => id === newOrder[i]);

            if (orderHasChanged) {
                orderChanged.style.display = 'block';
                orderButtons.style.display = 'flex';
            } else {
                orderChanged.style.display = 'none';
                orderButtons.style.display = 'none';
            }

            // Update allImages array to match new order
            allImages = newOrder.map(id => allImages.find(img => img.id === id));
        }

        // Delete image
        async function deleteImage(publicId) {
            if (!confirm('Weet je zeker dat je deze foto wilt verwijderen?')) {
                return;
            }

            const card = document.querySelector(`[data-id="${publicId}"]`);
            if (card) {
                card.classList.add('deleting');
            }

            try {
                const response = await fetch('/api/delete-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_id: publicId })
                });

                if (response.ok) {
                    // Remove from DOM
                    if (card) {
                        card.remove();
                    }
                    // Update count
                    const remaining = document.querySelectorAll('.image-card').length;
                    imageCount.textContent = `${remaining} foto('s) in portfolio`;

                    if (remaining === 0) {
                        existingImagesContainer.innerHTML = '<div class="loading">Geen foto\'s gevonden</div>';
                    }
                } else {
                    alert('Verwijderen mislukt. Probeer opnieuw.');
                    if (card) {
                        card.classList.remove('deleting');
                    }
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Verwijderen mislukt. Probeer opnieuw.');
                if (card) {
                    card.classList.remove('deleting');
                }
            }
        }

        // Make deleteImage available globally
        window.deleteImage = deleteImage;

        // Save order button
        saveOrderBtn.addEventListener('click', async () => {
            saveOrderBtn.disabled = true;
            saveOrderBtn.textContent = 'Opslaan...';

            try {
                const response = await fetch('/api/update-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: allImages })
                });

                if (response.ok) {
                    originalOrder = allImages.map(img => img.id);
                    orderHasChanged = false;
                    orderChanged.style.display = 'none';
                    orderButtons.style.display = 'none';
                    alert('Volgorde opgeslagen!');
                } else {
                    alert('Opslaan mislukt. Probeer opnieuw.');
                }
            } catch (error) {
                console.error('Save order error:', error);
                alert('Opslaan mislukt. Probeer opnieuw.');
            }

            saveOrderBtn.disabled = false;
            saveOrderBtn.textContent = 'Volgorde Opslaan';
        });

        // Reset order button
        resetOrderBtn.addEventListener('click', () => {
            loadExistingImages();
        });

        // Delete all images
        deleteAllBtn.addEventListener('click', async () => {
            if (allImages.length === 0) return;

            const count = allImages.length;

            // First confirmation
            if (!confirm(`Weet je zeker dat je ALLE ${count} foto('s) wilt verwijderen?`)) {
                return;
            }

            // Second confirmation - type to confirm
            const confirmText = prompt(`Dit is onomkeerbaar! Type "verwijder alles" om te bevestigen:`);
            if (confirmText !== 'verwijder alles') {
                alert('Verwijderen geannuleerd.');
                return;
            }

            deleteAllBtn.disabled = true;
            deleteAllBtn.textContent = `Verwijderen... 0/${count}`;

            let deleted = 0;
            let failed = 0;

            for (const img of allImages) {
                try {
                    const response = await fetch('/api/delete-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ public_id: img.id })
                    });

                    if (response.ok) {
                        deleted++;
                    } else {
                        failed++;
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    failed++;
                }

                deleteAllBtn.textContent = `Verwijderen... ${deleted + failed}/${count}`;
            }

            deleteAllBtn.disabled = false;
            deleteAllBtn.textContent = 'Alles Verwijderen';

            if (failed === 0) {
                alert(`Alle ${deleted} foto('s) zijn verwijderd.`);
            } else {
                alert(`${deleted} verwijderd, ${failed} mislukt.`);
            }

            loadExistingImages();
        });
    </script>
</body>
</html>
